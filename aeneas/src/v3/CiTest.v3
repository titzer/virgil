// Copyright 2026 Virgil authors. All rights reserved.
// See LICENSE for details of Apache 2.0 license.

// Adds testing capabilities to programs under the {CiTest} namespace.
component CiTestModule {
	def TYPECON = CiTest_TypeCon.new(TypeUtil.globalCache);

	def install(prog: Program) {
		prog.typeEnv.add(TYPECON);
	}
}

// The "CiTest" component exposes some operations that help with testing internals
// of the compiler, such as the register allocator.
class CiTest_TypeCon extends Member_TypeCon {
	new(typeCache: TypeCache) super("CiTest", Kind.VOID, 0, typeCache) { }

	def lookupMember(caller: VstFunc, t: Type, name: string) -> LookupResult {
		if (Strings.equal(name, "killRegisters")) {
			return LookupResult.Inst(V3Op.opKillRegisters, null);
		}
		return LookupResult.None;
	}
}