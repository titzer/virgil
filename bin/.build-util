#!/bin/bash

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  BIN="$(builtin cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$BIN/$SOURCE"
done
BIN="$(builtin cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

PROG=$1
shift

DIR=$1
shift

PROG_LINK=$BIN/$PROG
PROG_BIN=$BIN/utils/$PROG

T=/tmp/$USER/virgil-util-build/
OUT=/tmp/$USER/virgil-util-build/$PROG.log

mkdir -p $T

builtin cd $BIN/../$DIR && v3c-host -output=$BIN/utils/ -program-name=$PROG *.v3 $(cat DEPS) > $T/$PROG.log 2>&1

if [ "$?" != 0 ]; then
    echo $PROG: build from source failed, see $OUT
    exit $?
fi

rm -f $PROG_LINK
ln -s $PROG_BIN $PROG_LINK

git update-index --assume-unchanged $PROG_LINK
